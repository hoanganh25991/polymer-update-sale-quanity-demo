<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-behaviors/paper-button-behavior.html">
<link rel="import" href="../bower_components/dom-bindref/dom-bindref.html">

<link rel="import" href="dom-ref.html">

<dom-module id="my-firebase-list">
    <template>
        <style is="custom-style">
            :host {
                display: block;
                position: relative;
                border-radius: 3px;
                background-color: #fff;
            }
        </style>

        <content></content>
        <template
                is="dom-repeat"
                id="repeater"
                items="[[items]]">
        </template>
    </template>
    <script>
        Polymer({
            is: 'my-firebase-list',
            behaviors: [
                Polymer.Templatizer
            ],
            properties: {
                firebaseObj: {
                    type: Object,
                    reflectToAttribute: true
                },
                items: {
                    type: Array,
                    notify: true,
                },
                searchTerm: {
                    type: String,
                    reflectToAttribute: true
                },
                by: {
                    type: String,
                    value: 'name',
                    reflectToAttribute: true
                },
            },
            observers: [
                '_computeItems(firebaseObj, searchTerm, by)'
            ],
            _computeItems: function(firebaseObj, searchTerm, by){
                console.log('%c _computeItems', 'color: blue; font-weight: bold;');
//                console.log(searchTerm, by);
                if(false
                        || searchTerm == ''
                        || by == ''
                ){
                    console.log('Nothing to compute');
                    return;
                }

                let uuids = Object.keys(firebaseObj);
                let items = uuids.filter(function(uuid){
                    if(firebaseObj[uuid][by]){
                        return firebaseObj[uuid][by].match(new RegExp(searchTerm));
                    }

                    return false;
                });

//                this.set('items', items);
//                this.items = [];
//                this.items = items;
                this._delayUpdateItems(items);
            },
            ready: function(){
                this._modelBindItemTemplate();
            },
            _computeVal: function(uuid, path){
                return this.firebaseObj[uuid][path];
            },
            _computeItemHiddenAttr: function(uuid){
                return this.firebaseObj[uuid][this.by].match(new RegExp(this.searchTerm)) ? false : true;
            },
            _modelBindItemTemplate: function(){
                const itemContentTemplate = this.querySelector('#templ');
                this.$.repeater.templatize(itemContentTemplate);
                Polymer.Bind.prepareModel(this.$.repeater);
                Polymer.Base.prepareModelNotifyPath(this.$.repeater);
            },
            listeners: {
                /**
                 * Test complet, comment out
                 */
//                'items-changed': '_logPropertiesChanged'
            },
            _logPropertiesChanged: function(e){
                console.log('properties x changed');
                console.log(e);
            },
            _delayUpdateItems: function(items){
                this.set('items', []);
                (function(scope){
                    let delay = new Promise(function(resolve){
//                        setTimeout(resolve, 100);
                        setTimeout(resolve, 10);
                    });
                    delay.then(function(){
                        console.log('delay set items');
//                        console.log(scope);
                        scope.set('items', items);
                    });
                })(this);
//
            }
        });
    </script>
</dom-module>