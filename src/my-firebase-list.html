<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-behaviors/paper-button-behavior.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<dom-module id="my-firebase-list">
    <template>
        <style is="custom-style">
            :host {
                display: block;
                position: relative;
                border-radius: 3px;
                background-color: #fff;
            }
            paper-material {
                border-radius: inherit;
                padding: 16px;
            }
        </style>

        <template is="dom-repeat" items="[[items]]">
            <paper-material class="content" elevation="1" animated>
                <content></content>
            </paper-material>
        </template>
    </template>
    <script>
        Polymer({
            is: 'my-firebase-list',
            behaviors: [
                Polymer.PaperButtonBehavior,
                Polymer.Templatizer
            ],
            properties: {
                firebaseObj: {
                    type: Object,
                    reflectToAttribute: true
                },
                items: {
                    type: Array,
                    computed: '_computeItems(firebaseObj)'
                },
                currentItemUuid: {
                    type: String
                }
            },
            _computeItems: function(firebaseObj){
                return Object.keys(firebaseObj);
            },
            // Called as a side effect of a template item change, responsible
            // for notifying items.<key-for-inst> change up to host
            _forwardInstanceProp: function(inst, prop, value) {
                if (prop == this.as) {
                    var idx;
                    if (this._sortFn || this._filterFn) {
                        // Known slow lookup: when sorted/filtered, there is no way to
                        // efficiently memoize the array index and keep it in sync with array
                        // mutations, so we need to look the item up in the array
                        // This can happen e.g. when array of strings is repeated into inputs
                        idx = this.items.indexOf(this.collection.getItem(inst.__key__));
                    } else {
                        // When there is no sort/filter, the view index is the array index
                        idx = inst[this.indexAs];
                    }
                    this.set('items.' + idx, value);
                }
            },
            // Implements extension point from Templatizer
            // Called as a side effect of a template instance path change, responsible
            // for notifying items.<key-for-inst>.<path> change up to host
            _forwardInstancePath: function(inst, path, value) {
                if (path.indexOf(this.as + '.') === 0) {
                    this._notifyPath('items.' + inst.__key__ + '.' +
                            path.slice(this.as.length + 1), value);
                }
            },
            // Implements extension point from Templatizer mixin
            // Called as side-effect of a host property change, responsible for
            // notifying parent path change on each inst
            _forwardParentProp: function(prop, value) {
                var i$ = this._instances;
                for (var i=0, inst; (i<i$.length) && (inst=i$[i]); i++) {
                    if (!inst.isPlaceholder) {
                        inst.__setProperty(prop, value, true);
                    }
                }
            },
            // Implements extension point from Templatizer
            // Called as side-effect of a host path change, responsible for
            // notifying parent path change on each inst
            _forwardParentPath: function(path, value) {
                var i$ = this._instances;
                for (var i=0, inst; (i<i$.length) && (inst=i$[i]); i++) {
                    if (!inst.isPlaceholder) {
                        inst._notifyPath(path, value, true);
                    }
                }
            },
            ready: function(){
                var template = Polymer.dom(this).querySelector('template');
                this.templatize(template);
                this._instanceProps = {
                    item: true
                };
            },

        });
    </script>
</dom-module>